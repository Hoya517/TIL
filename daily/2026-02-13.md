
# 🚀 TIL - MSA 심화 정리  
## Service Discovery & Client-Side Load Balancing 구조 이해

---

## 1️⃣ 왜 MSA에서 Service Discovery가 필수인가?

MSA에서는 서비스가 수평 확장되며 인스턴스가 동적으로 생성·종료된다.

- IP / Port가 계속 변한다.
- 고정 URL 호출은 유지보수가 어렵다.
- 장애 인스턴스를 호출할 위험이 있다.

따라서 **서비스 이름 기반 호출 체계**가 필요하다.

---

## 2️⃣ Service Discovery 구조

### 구성 요소

- **Eureka Server**: 서비스 인스턴스 레지스트리
- **Eureka Client (Provider)**: 자신의 위치 등록 및 Heartbeat 유지
- **Eureka Client (Consumer)**: 서비스 이름으로 인스턴스 조회

### 동작 흐름

1. 서비스 실행
2. Eureka 등록
3. Heartbeat 유지
4. Consumer가 서비스 이름으로 조회
5. 인스턴스 선택 후 호출

---

## 3️⃣ Client-Side Load Balancing

### 서버 사이드 vs 클라이언트 사이드

| 구분 | 서버 사이드 | 클라이언트 사이드 |
|------|--------------|-------------------|
| 선택 주체 | 외부 LB | 애플리케이션 |
| 대상 선택 | LB가 선택 | 클라이언트가 직접 선택 |
| MSA 적합성 | 인프라 의존 | Eureka와 자연 결합 |

---

## 4️⃣ FeignClient 동작 원리

Feign은 선언형 HTTP Client로, 서비스 이름 기반 호출을 지원한다.

```java
@FeignClient(name = "product-service")
public interface ProductClient {

    @GetMapping("/product/{id}")
    String getProduct(@PathVariable("id") String id);
}
```

### 내부 동작

1. 서비스 이름으로 호출
2. Eureka에서 인스턴스 목록 조회
3. LoadBalancer가 인스턴스 선택
4. HTTP 요청 수행

---

## 5️⃣ 로드 밸런싱 알고리즘

### Round Robin (기본)

19092 → 19093 → 19094 → 반복

요청을 순차적으로 분배하여 특정 인스턴스 과부하를 방지한다.

---

## 6️⃣ 실습 아키텍처

| 서비스 | 인스턴스 | 포트 |
|---------|-----------|-------|
| Eureka | 1 | 19090 |
| Order | 1 | 19091 |
| Product | 3 | 19092, 19093, 19094 |

### 호출 흐름

http://localhost:19091/order/1  
→ OrderService  
→ FeignClient(product-service)  
→ LoadBalancer  
→ Product 인스턴스 선택  

요청할 때마다 응답 포트가 변경되며 Round Robin 동작을 확인할 수 있다.

---

## 🎯 오늘의 핵심 정리

- MSA에서는 IP 기반 호출이 아닌 서비스 이름 기반 호출을 사용한다.
- FeignClient는 내부적으로 LoadBalancer와 Eureka를 활용한다.
- 로드밸런싱은 MSA에서 선택이 아니라 필수 요소다.
- MSA는 단순 분리가 아니라 분산 시스템 설계 패턴이다.

---

## 🔥 다음 학습 목표

- Resilience4j 적용
- API Gateway 추가
- Docker Compose 기반 통합 실행
- 장애 시나리오 테스트
