# ğŸ” TIL - ë³´ì•ˆ êµ¬ì„± (OAuth2 + JWT) with Spring Cloud Gateway

## ğŸ“… Todayâ€™s Learning
- MSAì—ì„œ ë³´ì•ˆì´ ì¤‘ìš”í•œ ì´ìœ  ì •ë¦¬
- OAuth2 í•µì‹¬ ê°œë…(ì—­í• /íë¦„)ê³¼ Bearer Token ì´í•´
- JWT êµ¬ì¡°(Header/Payload/Signature)ì™€ ì¥ë‹¨ì  ì´í•´
- Auth Serviceì—ì„œ JWT ë°œê¸‰ ê¸°ëŠ¥ êµ¬í˜„ (jjwt)
- Cloud Gateway Pre(Global) Filterì—ì„œ JWT ê²€ì¦ ì ìš©
- í† í° ìœ ë¬´ì— ë”°ë¥¸ 401/ì •ìƒ ì‘ë‹µ ë™ì‘ í™•ì¸

---

# 1ï¸âƒ£ MSAì—ì„œ ë³´ì•ˆì´ ì¤‘ìš”í•œ ì´ìœ 

MSAì—ì„œëŠ” ì„œë¹„ìŠ¤ê°€ **ë¶„ë¦¬ë˜ì–´ ë°°í¬/ìš´ì˜**ë˜ê³ , ì„œë¹„ìŠ¤ ê°„ í˜¸ì¶œì´ **ë„¤íŠ¸ì›Œí¬**ë¥¼ í†µí•´ ë°œìƒí•œë‹¤.  
ë”°ë¼ì„œ ì•„ë˜ í•­ëª©ì´ ë³´ì•ˆ ì„¤ê³„ì˜ ê¸°ë³¸ì´ ëœë‹¤.

- **ì¸ì¦(Authentication)**: â€œëˆ„êµ¬ì¸ê°€?â€
- **ì¸ê°€(Authorization)**: â€œë¬´ì—‡ì„ í•  ìˆ˜ ìˆëŠ”ê°€?â€
- **í†µì‹  ë³´í˜¸(Encryption)**: ì „ì†¡ ì¤‘ íƒˆì·¨ ë°©ì§€(HTTPS)
- **í† í° ê¸°ë°˜ ì ‘ê·¼ ì œì–´**: ì„œë¹„ìŠ¤ê°€ ëŠ˜ì–´ë‚˜ë„ ê³µí†µ ì •ì±… ì ìš©

---

# 2ï¸âƒ£ OAuth2 ê°œìš”

OAuth2ëŠ” **í† í° ê¸°ë°˜ ì¸ì¦/ì¸ê°€ í”„ë¡œí† ì½œ**ì´ë‹¤.

## OAuth2 ì£¼ìš” ì—­í• (4ê°€ì§€)

- **Resource Owner**: ì‚¬ìš©ì(ë¦¬ì†ŒìŠ¤ ì†Œìœ ì)
- **Client**: ì‚¬ìš©ì ëŒ€ì‹  ë¦¬ì†ŒìŠ¤ì— ì ‘ê·¼í•˜ë ¤ëŠ” ì•±
- **Authorization Server**: ì¸ì¦/í† í° ë°œê¸‰ ì„œë²„
- **Resource Server**: ë³´í˜¸ëœ ë¦¬ì†ŒìŠ¤(ì„œë¹„ìŠ¤/API)ë¥¼ ì œê³µí•˜ëŠ” ì„œë²„

> ì˜¤ëŠ˜ ì‹¤ìŠµì—ì„œëŠ” OAuth2 ì „ì²´ í”Œë¡œìš°ë¥¼ êµ¬í˜„í•˜ê¸°ë³´ë‹¤,  
> í† í° ê¸°ë°˜ ì¸ì¦/ì¸ê°€ì˜ í•µì‹¬ ì•„ì´ë””ì–´ë¥¼ **JWT + Gateway í•„í„°**ë¡œ ì²´í—˜í–ˆë‹¤.

---

# 3ï¸âƒ£ JWT ê°œìš”

JWT(JSON Web Token)ëŠ” **ìê°€ í¬í•¨(Self-contained)** í† í°ì´ë‹¤.

## êµ¬ì¡° (Header.Payload.Signature)

- **Header**: í† í° íƒ€ì…, ì„œëª… ì•Œê³ ë¦¬ì¦˜
- **Payload**: Claim(ì˜ˆ: user_id, role, exp)
- **Signature**: ë¬´ê²°ì„± ê²€ì¦(ì„œëª…ê°’)

## íŠ¹ì§•

- ì„œë²„ê°€ ì„¸ì…˜ì„ ì €ì¥í•˜ì§€ ì•Šì•„ë„ ë˜ëŠ” **Stateless** êµ¬ì¡°ì— ì í•©
- í† í° ìì²´ë¡œ ì‚¬ìš©ì ì •ë³´ë¥¼ ì „ë‹¬ ê°€ëŠ¥(Claim)
- **ì„œëª…(Signature)** ìœ¼ë¡œ ìœ„ë³€ì¡°ë¥¼ ê²€ì¦ (ì•”í˜¸í™”ì™€ëŠ” ë‹¤ë¦„)

---

# 4ï¸âƒ£ ì‹¤ìŠµ ëª©í‘œ

- Auth Serviceì—ì„œ ë¡œê·¸ì¸ ìš”ì²­ ì‹œ JWT ë°œê¸‰
- Gatewayì—ì„œ **Pre Filterë¡œ JWT ê²€ì¦**
- í† í° ì—†ìœ¼ë©´ 401, ìˆìœ¼ë©´ Order/Product ì •ìƒ ë¼ìš°íŒ…

---

# 5ï¸âƒ£ ì‹¤ìŠµ êµ¬ì„±

- Eureka Server
- Gateway Service (ë¼ìš°íŒ… + JWT ê²€ì¦ í•„í„°)
- Auth Service (í† í° ë°œê¸‰)
- Product Service (ë³´í˜¸ ëŒ€ìƒ API)

ìš”ì²­ íë¦„:

Client  
â†’ Gateway  
â†’ (Pre Filter: JWT ê²€ì¦)  
â†’ Eureka ì¡°íšŒ ë° ë¼ìš°íŒ…  
â†’ Product/Order  
â†’ Response

---

# 6ï¸âƒ£ Auth Service êµ¬í˜„ ìš”ì•½

## ì˜ì¡´ì„±

```gradle
implementation 'io.jsonwebtoken:jjwt:0.12.6'
implementation 'org.springframework.boot:spring-boot-starter-security'
implementation 'org.springframework.cloud:spring-cloud-starter-netflix-eureka-client'
implementation 'org.springframework.boot:spring-boot-starter-web'
```

## JWT ë°œê¸‰

- claim: `user_id`, `role`
- issuer: `spring.application.name`
- expiration: `service.jwt.access-expiration`
- sign: HS512 + secret key

```java
public String createAccessToken(String user_id) {
    return Jwts.builder()
        .claim("user_id", user_id)
        .claim("role", "ADMIN")
        .issuer(issuer)
        .issuedAt(new Date(System.currentTimeMillis()))
        .expiration(new Date(System.currentTimeMillis() + accessExpiration))
        .signWith(secretKey, io.jsonwebtoken.SignatureAlgorithm.HS512)
        .compact();
}
```

## ë¡œê·¸ì¸ ì—”ë“œí¬ì¸íŠ¸

- `GET /auth/signIn?user_id=xxx`
- ì‘ë‹µ: `{ "access_token": "..." }`

---

# 7ï¸âƒ£ Gateway ì„¤ì • ìš”ì•½

## ë¼ìš°íŒ… ì¶”ê°€ (auth-service í¬í•¨)

```yaml
spring:
  cloud:
    gateway:
      routes:
        - id: order-service
          uri: lb://order-service
          predicates:
            - Path=/order/**
        - id: product-service
          uri: lb://product-service
          predicates:
            - Path=/product/**
        - id: auth-service
          uri: lb://auth-service
          predicates:
            - Path=/auth/signIn
```

- `lb://` â†’ Eureka ê¸°ë°˜ ë¡œë“œë°¸ëŸ°ì‹±/ë¼ìš°íŒ…

---

# 8ï¸âƒ£ Gateway Pre Filterì—ì„œ JWT ê²€ì¦

## í•µì‹¬ ë™ì‘

- `/auth/signIn` ì€ ì¸ì¦ ì—†ì´ í†µê³¼(í† í° ë°œê¸‰ ê²½ë¡œ)
- ê·¸ ì™¸ ìš”ì²­ì€ `Authorization: Bearer <token>` í•„ìš”
- í† í° ì—†ê±°ë‚˜ ê²€ì¦ ì‹¤íŒ¨ â†’ **401 UNAUTHORIZED**

```java
@Override
public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
    String path = exchange.getRequest().getURI().getPath();
    if (path.equals("/auth/signIn")) {
        return chain.filter(exchange);
    }

    String token = extractToken(exchange);

    if (token == null || !validateToken(token)) {
        exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);
        return exchange.getResponse().setComplete();
    }

    return chain.filter(exchange);
}
```

## í† í° ì¶”ì¶œ ê·œì¹™

- í—¤ë”: `Authorization`
- í¬ë§·: `Bearer <JWT>`

---

# 9ï¸âƒ£ ì‹¤í–‰/ê²€ì¦ ê²°ê³¼

1) í† í° ì—†ì´ Product í˜¸ì¶œ  
- `GET http://localhost:19091/product`  
â†’ **401**

2) ë¡œê·¸ì¸ìœ¼ë¡œ í† í° ë°œê¸‰  
- `GET http://localhost:19091/auth/signIn?user_id=test`  
â†’ access_token íšë“

3) í† í° í¬í•¨í•´ì„œ Product í˜¸ì¶œ  
- `Authorization: Bearer <token>`  
- `GET http://localhost:19091/product`  
â†’ **200 + ì •ìƒ ì‘ë‹µ**

---

# ğŸ” Bearer Token ì •ë¦¬

- OAuth2ì—ì„œ ì‚¬ìš©í•˜ëŠ” í† í° ì „ë‹¬ ë°©ì‹ ì¤‘ í•˜ë‚˜
- í´ë¼ì´ì–¸íŠ¸ëŠ” Bearer íƒ€ì…ìœ¼ë¡œ í† í°ì„ í—¤ë”ì— ì‹¤ì–´ ì „ë‹¬
- ì„œë²„ëŠ” ì„œëª…/ë§Œë£Œ ë“±ì„ ê²€ì¦í•´ ìš”ì²­ì„ ìŠ¹ì¸

**ì£¼ì˜**: Bearer í† í°ì€ íƒˆì·¨ë˜ë©´ ë°”ë¡œ ì‚¬ìš©ë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, HTTPS ì „ì†¡ì´ ê¸°ë³¸ì´ë‹¤.

---

# ğŸ¯ ì˜¤ëŠ˜ì˜ í•µì‹¬ ì¸ì‚¬ì´íŠ¸

- MSA ë³´ì•ˆì€ ì„œë¹„ìŠ¤ë³„ êµ¬í˜„ì´ ì•„ë‹ˆë¼ **ì§„ì…ì (ê²Œì´íŠ¸ì›¨ì´)ì—ì„œ í†µì œ**í•˜ëŠ” ë°©ì‹ì´ íš¨ê³¼ì ì´ë‹¤.
- JWTëŠ” Statelessì— ê°•í•˜ì§€ë§Œ, **ë§Œë£Œ/íê¸°(ë¡œê·¸ì•„ì›ƒ) ì „ëµ**ì€ ë³„ë„ ì„¤ê³„ê°€ í•„ìš”í•˜ë‹¤(ì˜ˆ: Redis blacklist).
- Gateway í•„í„°ëŠ” ê³µí†µ ì •ì±…(ì¸ì¦/ë¡œê¹…/ì œí•œ)ì„ í•œ ê³³ì— ëª¨ìœ¼ëŠ” ê°•ë ¥í•œ ìˆ˜ë‹¨ì´ë‹¤.

---

# ğŸ ì •ë¦¬

ì˜¤ëŠ˜ì€ OAuth2ì˜ í† í° ê¸°ë°˜ ì¸ì¦ ì•„ì´ë””ì–´ë¥¼ ë°”íƒ•ìœ¼ë¡œ,  
**Auth Serviceì—ì„œ JWT ë°œê¸‰ â†’ Gateway Pre Filterì—ì„œ ê²€ì¦ â†’ ë³´í˜¸ API ì ‘ê·¼** íë¦„ì„ ì‹¤ìŠµí–ˆë‹¤.

ë‹¤ìŒ í™•ì¥ í¬ì¸íŠ¸:
- role ê¸°ë°˜ ì¸ê°€(Authorization) ì¶”ê°€
- í† í° ë§Œë£Œ/ê°±ì‹ (Refresh Token) ì„¤ê³„
- ë¸”ë™ë¦¬ìŠ¤íŠ¸/ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬(ì˜ˆ: Redis)
- Gatewayì—ì„œ ì‚¬ìš©ì ì»¨í…ìŠ¤íŠ¸ ì „ë‹¬(Headers/Claims)
